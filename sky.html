<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Sky ü™ê</title>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
        <link rel="stylesheet" href="https://jenil.github.io/bulmaswatch/darkly/bulmaswatch.min.css">
        <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
        <script src="https://veikkosalminen.github.io/ephemeris-1.2.1.bundle.js"></script>
        <script src="https://veikkosalminen.github.io/radtoaa.js"></script>
        <script src="https://veikkosalminen.github.io/sky-objects.js"></script>
        

        <!-- Don't use this in production: -->
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    </head>

    <body>
        <div id="root"></div>
        <script type="text/babel">

            const degminsec = (deg) => {
                const d = Math.floor(deg)
                const minfloat = (deg - d) * 60
                const m = Math.floor(minfloat)
                const secfloat = (minfloat - m) * 60
                const s = Math.round(secfloat)
                return `${d}¬∞ ${m}' ${s}"`
            }

            const degmin = (deg) => {
                const d = Math.floor(deg)
                const minfloat = (deg - d) * 60
                const m = Math.floor(minfloat)
                return `${d}¬∞`
            }

            const hoursminsecToDegrees = ({hours, minutes, seconds}) => {
                return (hours + minutes / 60 + seconds / 3600) * 15
            }

            const getAutoTime = (day, lat, lon) => {

                const date = new Date()
                date.setDate(day)

                const ephemeris = new Ephemeris.default({
                    key: ["sun"],
                    year: date.getFullYear(), month: date.getMonth(), day: date.getDate(), hours: date.getHours() + date.getTimezoneOffset()/60, minutes: date.getMinutes(),
                    latitude: lat, longitude: lon,
                    calculateShadows: false
                })

                const sunsetHour = ephemeris.sun.position.altaz.transit.approxSetUT.hours - date.getTimezoneOffset()/60

                if (sunsetHour > date.getHours()) {
                    date.setHours(sunsetHour + 2 <= 23 ? sunsetHour + 2 : 23)
                    date.setMinutes(0)
                }

                return date
            }

            function ShowLocation({altaz, magnitude}) {
                let {alt, az} = altaz
               
                return <>üëÜ {degmin(alt)} &nbsp;&nbsp; üß≠ {degmin(az)} &nbsp;&nbsp; ‚ú® {magnitude} </>
            }

            function Card({object}) {

                const {name, img, stars, points, altaz, description, magnitude, link } = object

                return <div className="block"><div className="card">
                    <div className="card-image">
                        <figure className="image is-4by4">
                        <img src={img ||¬†"https://bulma.io/images/placeholders/1280x960.png"} alt="Placeholder image" />
                        </figure>
                    </div>
                    <div className="card-content">
                        <div className="media">
                        <div className="media-left">
                            <figure className="image is-48x48">
                            <MapIcon altaz={altaz} />
                            </figure>
                        </div>
                        <div className="media-content">
                            <p className="title is-4">{name}</p>
                            <p className="subtitle is-7">{!!altaz && <ShowLocation altaz={altaz} magnitude={magnitude} />}</p>
                        </div>
                        </div>

                        <div className="content">
                        { description } {!!link && <a href={link}>@Wikipedia</a>}
                        </div>
                        <div className="content">
                            {[...Array(stars).keys()].map(() => "‚≠êÔ∏è")} {Math.floor(points*10)/10}
                        </div>
                    </div>
                    </div>
                    </div>
            }

            function MapIcon({altaz}) {

                const size = 380

                // convert altitude and azimuth to x and y coordinates
                const {alt, az} = altaz
                const x = 400 - size * Math.sin(az * Math.PI / 180) * Math.cos(alt * Math.PI / 180)
                const y = 400 - size * Math.cos(az * Math.PI / 180) * Math.cos(alt * Math.PI / 180)

                const color = "#0055ab"

                return <svg width="48" height="48" viewBox="0 0 800 800" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <ellipse cy="400" cx="400" ry="380" rx="380" stroke={color} fill="#061329" strokeWidth="10"/>
                        <ellipse cy="400" cx="400" ry="200" rx="200" stroke={color} fill="none" strokeWidth="7" />
                        
                        <line y2="400" x2="780" y1="400" x1="20" stroke={color} fill="none" strokeWidth="10" />
                        <line y2="120" x2="120" y1="680" x1="680" stroke={color} fill="none" strokeWidth="3" />
                        <line y2="780" x2="400" y1="20" x1="400" stroke={color} fill="none" strokeWidth="10" />
                        <line y2="680" x2="120" y1="120" x1="680" stroke={color} fill="none" strokeWidth="3" />

                        <ellipse cy={y} cx={x} ry="30" rx="30" stroke="yellow" fill="yellow" />
                        
                    </g>
                </svg>
            }

            const roundBy = (number, decimals) => {
                const rounder = Math.pow(10, decimals)
                return Math.round(number*rounder)/rounder
            }

            function ObjectFilter({filterChange}) {

                const [filter, setFilter] = React.useState(null)

                const filters = [
                    {name: null, label: "Recommended"},
                    {name: "messier", label: "Messier"},
                    {name: "galaxies", label: "Galaxies"},
                    {name: "planet", label: "Planets"},
                    {name: "nebulae", label: "Nebulae"},
                ]

                const next = () => {
                    const index = filters.findIndex(f => f.name === filter)
                    if (index < filters.length-1) {
                        filterChange(filters[index+1].name)
                        setFilter(filters[index+1].name)
                    }
                    else {
                        filterChange(filters[0].name)
                        setFilter(filters[0].name)
                    }
                }

                return <button onClick={() => next()} className="is-ghost button is-small">{filters.find(a => a.name === filter).label}</button>
            }

            function SkyList({ date, objects, next, prev, lat, lon, filterChange }) {
                return <section className="section">
                    <div className="container">
                        <nav className="level is-mobile">
                            <div className="level-left">
                                <h1 className="title">
                                    <div className="control">
                                        <input className="input" type="date"  />
                                    </div>
                                </h1>
                            </div>
                            <div className="level-right">
                                <div className="buttons has-addons">
                                    <button onClick={() => prev && prev()} className="button">‚óÄÔ∏é</button>
                                    <button onClick={() => next && next()} className="button">‚ñ∂Ô∏é</button>
                                </div>
                            </div>
                        </nav>
                        <nav className="level is-mobile">
                            <div className="level-left">
                                <p className="subtitle">
                                    {roundBy(lat, 3)}¬∞ {roundBy(lon, 3)}¬∞
                                </p>
                            </div>
                            <div className="level-right">
                                <ObjectFilter filterChange={filterChange}/>
                            </div>
                        </nav>
                        {objects.map((obj) => <Card key={obj.name} object={obj} />)}
                        </div>
                </section>
            }

            const calculatePoints = (objects) => {

                const getPoints = (object) => {
                    const {magnitude, stars, altaz} = object
                    const {alt, az} = altaz
                    
                    const cofficientAlt = 0.3
                    const cofficientMagnitude = 0.2
                    const cofficientStars = 0.5

                    const altitudePoints = alt / 90 * cofficientAlt
                    const magnitudePoints = (8.5 - (magnitude < 0 ? 0 : magnitude)) / 8.5 * cofficientMagnitude
                    const starsPoints = (stars | 0) / 3 * cofficientStars

                    const decimal = altitudePoints + magnitudePoints + starsPoints
                    
                    return decimal * 10
                }

                return objects.map( a => ({...a, points: getPoints(a)}) )
            }

            const filterObjectsTooLow = (objects, limitAltitudeDegrees) => {
                return objects.filter( (a) => a.altaz.alt > limitAltitudeDegrees )
            }

            const filterObjectsTooDim = (objects, limitMagnitude) => {
                return objects.filter( (a) => a.magnitude < limitMagnitude )
            }

            const filterObjectsWithFilter = (objects, filter) => {
                if (!filter) return objects

                if (filter === "galaxies") {
                    return objects.filter( (a) => ["SG", "EG", "IR", "IG"].includes(a.messiertype) )
                }

                if (filter === "nebulae") return objects.filter( (a) => ["DN", "PN"].includes(a.messiertype) )

                return objects.filter( (a) => a.type === filter )
            }

            const fillMessierData = ({objects, lat, lon, date}) => {

                const obs = {
                    "name": "Helsinki",
                    "year": date.getFullYear(),
                    "month": date.getMonth() + 1,
                    "day": date.getDate(),
                    "hours": date.getHours(),
                    "minutes": date.getMinutes(),
                    "seconds": date.getSeconds(),
                    "tz": date.getTimezoneOffset(),
                    "latitude": lat,
                    "longitude": -1 * lon,
                }

                return objects.map((obj) => {
                    const altaz = RadToAA(obj.ra, obj.dec, obs)
                    //const img = images[obj.name]
                    const typeMap = {OC: "openclusters", GC: "globularclusters", dbl: "stars", SG: "galaxies", EG: "galaxies", IR: "galaxies", IG: "galaxies", PN: "planetarynebulae", DN: "diffusenebulae"}
                    const astroPixelType = obj.name === "M1" ? "supernovae" : typeMap[obj.messiertype]
                    const img = obj.img || "//wsrv.nl/?url=astropixels.com/" + astroPixelType + "/images/" + obj.name + "-01z.jpg"
                    
                    const wikiLink = `https://en.wikipedia.org/wiki/Messier_${obj.name.substring(1)}`
                    const stellariumLink = `https://stellarium-web.org/skysource/${obj.name}?fov=120.00&date=${date.toISOString()}&lat=${lat}&lng=${lon}&elev=0`
                    const description = <>{obj.description} <a href={wikiLink}>@wikipedia</a> <a href={stellariumLink}>@stellarium</a></>
                    
                    return {...obj, altaz, img, description}
                })
            }

            const fillPlanetData = ({objects, lat, lon, date}) => {

                const ephemeris = new Ephemeris.default({
                    year: date.getFullYear(), month: date.getMonth(), day: date.getDate(), hours: date.getHours() + date.getTimezoneOffset()/60, minutes: date.getMinutes(),
                    latitude: lat, longitude: lon,
                    calculateShadows: false
                })

                return objects.map( planet => {
                    const ephemeri = ephemeris[planet.name.toLowerCase()]
                    const alt = ephemeri.position.altaz.topocentric.altitude
                    const az = ephemeri.position.altaz.topocentric.azimuth
                    const altaz = {alt, az}
                    const link = "https://en.wikipedia.org/wiki/" + planet.name
                    const stellariumLink = `https://stellarium-web.org/skysource/${planet.name}?fov=120.00&date=${date.toISOString()}&lat=${lat}&lng=${lon}&elev=0`
                    const description = <>{planet.description} <a href={link}>@wikipedia</a> <a href={stellariumLink}>@stellarium</a></>
                    return {...planet, altaz, magnitude: ephemeri.magnitude | 0, description}
                })
            }

            const niceDateForHeader = (date) => {
                const now = new Date()
                // Today 18:00
                let dateStr = date.toISOString().substring(0, 10)

                if (date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth() && date.getDate() === now.getDate()) {
                    dateStr =  "Today"
                }

                const time =  date.getHours() + ":" + (date.getMinutes() < 10 ? "0" : "") + date.getMinutes()

                return dateStr + " " + time
            }

            function Main() {

                const [filter, setFilter] = React.useState(null)
                const [day, setDay] = React.useState((new Date()).getDate())

                const lat = 60.812171
                const lon = 25.127962

                const now = getAutoTime(day, lat, lon)

                const skyObjects = getSkyObjects()

                let objects = [].concat(
                    fillMessierData({objects: skyObjects.messier, lat: lat, lon: lon, date: now}), 
                    fillMessierData({objects: skyObjects.others, lat: lat, lon: lon, date: now}), 
                    fillPlanetData({objects: skyObjects.planets, lat: lat, lon: lon, date: now})
                )
                

                objects = calculatePoints(objects)
                objects = filterObjectsWithFilter(objects, filter)
                
                if (!filter) {
                    objects = filterObjectsTooLow(objects, 10)
                    objects = filterObjectsTooDim(objects, 8.5)
                }

                const orderObjects = objects.sort((a, b) => b.points - a.points)

                return <SkyList 
                    date={niceDateForHeader(now)} 
                    objects={orderObjects.slice(0, 30)} 
                    prev={() => setDay(day - 1)} 
                    next={() => setDay(day + 1)}
                    lat={lat} lon={lon} 
                    filterChange={(filter) => setFilter(filter)}
                />
            }

            ReactDOM.render(
                <Main />,
                document.getElementById('root')
            );

        </script>
    </body>

</html>
